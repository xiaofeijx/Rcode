---
title: "传染病报告卡检查<ae><bb><a5>"
output:
  html_document: default
---

2015年2月15日

```{r echo=FALSE,warning=FALSE,message=FALSE,tidy=TRUE}
library(dplyr)
library(xtable)
df <- read.csv("report.csv",header=T,stringsAsFactors=F,na.strings = ".")
if (nchar(df[1,19])== 17 ) #如果用EXCEl修改并保存，时间格式会变化
{  
  df <- read.csv("Report.csv",skip=2,header=T,stringsAsFactors=F,na.strings = ".")
#head(df)
#str(df)
df[,18] <- as.POSIXct(df[,18])
df[,19] <- as.POSIXct(df[,19],format="%Y-%m-%d %H:%M:")
df[,26] <- as.POSIXct(df[,26])
df[,30] <- as.POSIXct(df[,30],format="%Y-%m-%d %H:%M:")
df[,33] <- as.POSIXct(df[,33],format="%Y-%m-%d %H:%M:")
df[,34] <- as.POSIXct(df[,34],format="%Y-%m-%d %H:%M:")
df[,35] <- as.POSIXct(df[,35],format="%Y-%m-%d %H:%M:")
df[,37] <- as.POSIXct(df[,37],format="%Y-%m-%d %H:%M:")
df[,38] <- as.POSIXct(df[,38],format="%Y-%m-%d %H:%M:")
} else 
  {
    df[,18] <- as.POSIXct(df[,18])
    df[,26] <- as.POSIXct(df[,26])
df[,19] <- as.POSIXct(df[,19],format="%Y/%m/%d %H:%M")
df[,30] <- as.POSIXct(df[,30],format="%Y/%m/%d %H:%M")
df[,33] <- as.POSIXct(df[,33],format="%Y/%m/%d %H:%M")
df[,34] <- as.POSIXct(df[,34],format="%Y/%m/%d %H:%M")
df[,35] <- as.POSIXct(df[,35],format="%Y/%m/%d %H:%M")
df[,37] <- as.POSIXct(df[,37],format="%Y/%m/%d %H:%M")
df[,38] <- as.POSIXct(df[,38],format="%Y/%m/%d %H:%M")
  }


#nchar(df[,9])
df$age <- ifelse(substr(df[,9],nchar(df[,9]),nchar(df[,9]))=="岁",
              as.numeric(substr(df[,9],1,nchar(df[,9])-1)),
              as.numeric(substr(df[,9],1,nchar(df[,9])-1))/12)
df$报告单位 <- gsub(" ","",df$报告单位)

```
**报告病种统计**
```{r echo=FALSE,results='asis'}
df_df <- group_by(df,疾病名称)
smdf <- summarise(df_df,count=n())
arrange(smdf,desc(count)) %>% as.data.frame() %>% xtable() %>% print(type="html")
```


**少见病种显示**
```{r}
commondisease <- c("艾滋病","ＨＩＶ","甲肝","乙肝","丙肝","戊肝","肝炎（未分型）","细菌性痢疾","伤 寒","副伤寒","猩 红 热","淋    病","Ⅰ期梅毒","Ⅱ期梅毒","III期梅毒","胎传梅毒","隐性梅毒","流行性感冒","流行性腮腺炎","风疹","急性出血性结膜炎","尖锐湿疣","生殖器疱疹","结核性胸膜炎","水痘","生殖道沙眼衣原体感染","其它疾病:","手足口病","其它感染性腹泻病","涂（+）","菌（-）","未痰检")
rarefilter <- !(df$疾病名称 %in% commondisease)
select(df,c(4,7,9,14,19,21,28,30)) %>% filter(rarefilter) 
```


**甲类与甲类传染病报告时限检查>=2小时**
```{r}
classone <- df[,21] %in% c("鼠 疫","霍 乱","传染性非典","脊 灰","肺炭疽")
select(df,c(4,7,9,14,19,21,28,30)) %>% filter(difftime(df$报告卡录入时间,df$诊断时间,units="hours") >= 2 & classone)

```


**所有报告疾病报告时限检查>=24小时**
```{r, echo=FALSE}
df[difftime(df[,30],df[,19],units="days") >= 1, c(4,7,9,14,19,21,28)]
select(df,c(4,7,9,14,19,21,28,30)) %>% filter(difftime(df$报告卡录入时间,df$诊断时间,units="hours") >= 2 & classone)
```


**订正报告卡时限检查（含甲乙类）**
```{r}
modifieddf <- df[!is.na(df[,37]),]
mclassone <- modifieddf[,21] %in% c("鼠 疫","霍 乱","传染性非典","脊 灰","肺炭疽")
modifieddf[difftime(modifieddf[,38],modifieddf[,37],units="hours") >= 2 & mclassone, c(4,7,9,14,19,21,28)]

modifieddf[difftime(modifieddf[,30],modifieddf[,19],units="days") >= 1, c(4,7,9,14,19,21,28)]
```


**年龄与职业关系**
```{r}
#14岁以下只能是:散居、幼托和学生
agefilter1 <- !(df$职业 %in% c("散居儿童","幼托儿童","学生")) & df$age <14
select(df,c(4,7,9,15,19,21,28,30)) %>% filter(agefilter1)
```


```{r}
#是3岁以下是散居儿童
agefilter2 <- (!(df$职业 %in% c("散居儿童")) & df$age<3) | ((df$职业 %in% c("散居儿童")) & df$age>=5) 
select(df,c(4,7,9,15,19,21,28,30)) %>% filter(agefilter2)
```


```{r}
#4岁到6岁为为幼托儿童
agefilter3 <- !(df$职业 %in% c("幼托儿童")) & (df$age>4 & df$age <=6) | ((df$职业 %in% c("幼托儿童")) & df$age>=7)
select(df,c(4,7,9,15,19,21,28,30)) %>% filter(agefilter3)
```


```{r}
#7-14岁为学生
agefilter4 <- !(df$职业 %in% c("学生")) & (df$age>=7 & df $age <=14)
select(df,c(4,7,9,15,19,21,28,30)) %>% filter(agefilter4)
```


**职业与单位**
```{r}
occufilter <- (df$职业 %in% c("幼托儿童","学生","干部职员","工人","民工","教师","医务人员")) & (nchar(df$患者工作单位)<=2 | (df$患者工作单位=="不详") |(df$患者工作单位=="无"))
select(df,c(4,7,9,10,15,19,21,28,30)) %>% filter(occufilter)
```


**病种与分类的关系**
```{r}
yigan <- (df$疾病名称 == "乙肝") & !(df$病例分类 %in% c("实验室确诊病例","病原携带者"))
afp <- (df$疾病名称 == "AFP") & (df$病例分类 !="临床诊断病例")
weitanjian <- (df$疾病名称 == "未痰检") & (df$病例分类 !="疑似病例")
tuyang <- (df$疾病名称 == "涂（+）") & (df$病例分类 !="实验室确诊病例")
junying <- (df$疾病名称 == "菌（-）") & (df$病例分类 !="临床诊断病例")
sexdisease <-  (df$疾病名称 %in% c("Ⅰ期梅毒","Ⅱ期梅毒","III期梅毒","胎传梅毒","隐性梅毒","淋    病")) & (df$病例分类 !="实验室确诊病例")
diseasefilter <- yigan | afp | weitanjian | tuyang | junying | sexdisease 
select(df,c(4,7,9,10,15,19,21,28,30)) %>% filter(diseasefilter)
```

**不详乡镇**
```{r}
addressfilter <- grep("不详",df$现住详细地址)
df[addressfilter,c(4,7,9,10,14,15,19,21,28,30)]

```